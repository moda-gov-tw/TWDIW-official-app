<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <property name="HOST_NAME" value="${ISSUER_HOST_NAME}"/>
    <property name="VC_INT_URL" value="${VC_INTERNAL_URL}"/>

    <changeSet id="20000000000001" author="jhipster">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="credential_issuer_config" schemaName="vc"/>
            </not>
        </preConditions>
        <createTable tableName="credential_issuer_config">
            <column name="vc_id" type="varchar(32)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="credential_offer" type="varchar(512)"/>
            <column name="credential_issuer_meta" type="varchar(4000)"/>
            <column name="credential_issuer_identifier" type="varchar(128)"/>
            <column name="credential_offer_uri_path" type="varchar(128)"/>
            <column name="db_secret" type="varchar(128)"/>
            <column name="db_iv" type="varchar(128)"/>
            <column name="app_url_scheme" type="varchar(128)"/>
            <column name="credential_url" type="varchar(128)"/>
        </createTable>

        <createTable tableName="pre_auth_code">
            <column name="user_id" type="varchar(256)">
                <constraints nullable="false"/>
            </column>
            <column name="nonce" type="varchar(96)">
                <constraints nullable="false"/>
            </column>
            <column name="client_id" type="varchar(32)"/>
            <column name="create_time" type="timestamp with timezone">
                <constraints nullable="false"/>
            </column>
            <column name="expire_time" type="timestamp with timezone">
                <constraints nullable="false"/>
            </column>
            <column name="code_status" type="varchar(20)"/>
            <column name="credential_configuration_id" type="varchar(128)"/>
            <column name="pre_code" type="varchar(128)"/>
            <column name="tx_code" type="varchar(10)">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="user_id, nonce" tableName="pre_auth_code"/>
        <createIndex indexName="idx_pre_auth_code_client_id_pre_code" tableName="pre_auth_code">
            <column name="client_id"/>
            <column name="pre_code"/>
        </createIndex>

        <loadUpdateData
            file="config/liquibase/data/credential_issuer_config.csv"
            separator=";"
            tableName="credential_issuer_config"
            primaryKey="vc_id"
            usePreparedStatements="true">
            <column name="vc_id" header="vc_id"/>
            <column name="credential_offer" header="credential_offer"/>
            <column name="credential_issuer_meta" header="credential_issuer_meta"/>
            <column name="credential_issuer_identifier" header="credential_issuer_identifier"/>
            <column name="credential_offer_uri_path" header="credential_offer_uri_path"/>
            <column name="db_secret" header="db_secret"/>
            <column name="db_iv" header="db_iv"/>
            <column name="app_url_scheme" header="app_url_scheme"/>
            <column name="credential_url" header="credential_url"/>
        </loadUpdateData>

        <update tableName="credential_issuer_config">
            <column name="credential_offer" value="{&quot;grants&quot;:{&quot;urn:ietf:params:oauth:grant-type:pre-authorized_code&quot;:{&quot;pre-authorized_code&quot;:&quot;942569821&quot;}},&quot;credential_configuration_ids&quot;:[],&quot;credential_issuer&quot;:&quot;https://${HOST_NAME}/oid4vci/api/issuer/&quot;}"/>
            <column name="credential_issuer_identifier" value="https://${HOST_NAME}/oid4vci/api/issuer/"/>
            <column name="credential_url" value="${VC_INT_URL}/api/credential"/>
            <where>vc_id = 'template'</where>
        </update>
    </changeSet>

    <changeSet id="20000000000002" author="jhipster">
        <createTable tableName="credential_access_token">
            <column name="token_value" type="varchar(128)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="client_id" type="varchar(32)"/>
            <column name="user_id" type="varchar(256)"/>
            <column name="create_time" type="timestamp with timezone">
                <constraints nullable="false"/>
            </column>
            <column name="expire_time" type="timestamp with timezone">
                <constraints nullable="false"/>
            </column>
            <column name="nonce_from_idp" type="varchar(128)"/>
            <column name="c_nonce" type="varchar(128)"/>
            <column name="c_nonce_create_time" type="timestamp with timezone">
                <constraints nullable="false"/>
            </column>
            <column name="c_nonce_expire_time" type="timestamp with timezone">
                <constraints nullable="false"/>
            </column>
            <column name="authorization_details" type="varchar(4000)"/>
            <column name="pre_auth_code" type="varchar(128)"/>
            <column name="token_status" type="varchar(20)"/>
            <column name="additional_info" type="varchar(4000)"/>
        </createTable>
        <createIndex indexName="idx_access_token_token_value_client_id" tableName="credential_access_token">
            <column name="token_value"/>
            <column name="client_id"/>
        </createIndex>
        <createIndex indexName="idx_access_token_client_id_user_id" tableName="credential_access_token">
            <column name="client_id"/>
            <column name="user_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="20000000000003" author="jhipster">
        <createTable tableName="oidvci_setting">
            <column name="setting_name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="setting_value" type="varchar"/>
        </createTable>

        <loadUpdateData
            file="config/liquibase/data/oidvci_setting.csv"
            separator=";"
            tableName="oidvci_setting"
            primaryKey="setting_name"
            usePreparedStatements="true">
            <column name="setting_name" header="setting_name"/>
            <column name="setting_value" header="setting_value"/>
        </loadUpdateData>
    </changeSet>
</databaseChangeLog>
